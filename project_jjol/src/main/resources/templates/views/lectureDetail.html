<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/main_layout}">

<head>
    <meta charset="UTF-8">
    <title>강의 소개 페이지</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/lectureDetail.css}">
    <script th:src="@{/js/lectureDetail.js}"></script>
</head>

<body>
    <th:block layout:fragment="content">
        <div class="container lecture-detail-main-container">
            <div class="lecture-detail-header-section">
                <div class="lecture-detail-video-container">
                    <video controls autoplay th:src="${lecture.lectureThumbnailVideo}">
                        <source th:src="${lecture.lectureThumbnailVideo}" type="video/mp4">
                    </video>
                </div>
                <div class="lecture-detail-course-info">
                    <div class="lecture-detail-course-title" th:text="${lecture.lectureTitle}" id="lectureTitle"></div>
                    <div class="lecture-detail-course-details">
                        <div>
                            <i class="fas fa-user"></i> <span th:text="'강사: ' + ${lecture.instructorName}"></span>
                        </div>
                        <div>
                            <i class="fas fa-star"></i> <span th:text="'평점: ' + ${averageRating} + ' 점' + ' (' + ${reviews.size()} + '개의 수강평)'"></span>
                        </div>
                        <div>
                            <i class="fas fa-users"></i> <span th:text="${numberOfStudents} + '명의 수강생'"></span>
                        </div>
                        <div>
                            <i class="fa-solid fa-wallet"></i> <span class="lecturePrice" th:text="'가격: ' + ${lecture.lecturePrice} + '원'"></span> <span id="lectureDiscount">(할인 [[ ${lecture.lectureDiscount} ]]% 적용)</span>
                        </div>
                        <div>
                            <i class="fas fa-tags"></i> <span>태그: </span>
                            <span class="badge badge-primary">Java</span>
                            <span class="badge badge-secondary">Spring</span>
                            <span class="badge badge-success">MVC</span>
                            <span class="badge badge-info">Spring Boot</span>
                        </div>
                    </div>
                    <div class="mt-3">
					    <button class="btn btn-outline-light btn-sm" id="shareButton">공유하기</button>
					    <div class="share-message" id="shareMessage">복사 완료</div>
					</div>
                    <div class="mt-3">
                        <span th:text="'로그인된 사용자: ' + ${loggedInUser.name}"></span>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-12 col-lg-8 lecture-detail-left-column">
                    <div class="lecture-detail-progress-container">
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" style="width: 14.29%;" aria-valuenow="14.29" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <p class="mt-2">진도율: 4강/28강 (14.29%)</p>
                    </div>
                    <ul class="nav nav-tabs" id="myTab" role="tablist">
                        <li class="nav-item"><a class="nav-link active" id="description-tab" data-toggle="tab" href="#description" role="tab" aria-controls="description" aria-selected="true">강의소개</a></li>
                        <li class="nav-item"><a class="nav-link" id="reviews-tab" data-toggle="tab" href="#reviews" role="tab" aria-controls="reviews" aria-selected="false">수강평</a></li>
                        <li class="nav-item"><a class="nav-link" id="questions-tab" data-toggle="tab" href="#questions" role="tab" aria-controls="questions" aria-selected="false">Q&A</a></li>
                    </ul>
                    <div class="tab-content lecture-detail-tab-content" id="myTabContent">
                        <div class="tab-pane fade show active" id="description" role="tabpanel" aria-labelledby="description-tab">
                            <div class="lecture-detail-content-section">
                                <h3>강의 소개</h3>
                                <p th:text="${lecture.lectureLongDescription}"></p>
                                <h5>이런 걸 배워요!</h5>
                                <ul>
                                    <li>예제를 만들며 자연스럽게 스프링을 이해할 수 있습니다.</li>
                                    <li>스프링을 어떻게 공부해야 하는지 예제를 만들며 배울 수 있습니다.</li>
                                    <li>스프링으로 웹 애플리케이션을 만드는 방법을 배울 수 있습니다.</li>
                                </ul>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="reviews" role="tabpanel" aria-labelledby="reviews-tab">
                            <div class="lecture-detail-content-section">
                                <h3>수강평</h3>
                                <div th:if="${hasApplied}">
                                    <form th:action="@{/lectures/review}" method="post" onsubmit="localStorage.setItem('activeTab', '#reviews');">
                                        <input type="hidden" name="lectureId" th:value="${lecture.lectureId}">
                                        <div class="form-group">
                                            <label for="rating">별점 (0.5~5.0)</label>
                                            <select class="form-control" id="rating" name="rating" required>
                                                <option value="0.5">0.5</option>
                                                <option value="1">1.0</option>
                                                <option value="1.5">1.5</option>
                                                <option value="2">2.0</option>
                                                <option value="2.5">2.5</option>
                                                <option value="3">3.0</option>
                                                <option value="3.5">3.5</option>
                                                <option value="4">4.0</option>
                                                <option value="4.5">4.5</option>
                                                <option value="5">5.0</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="reviewContent">리뷰 내용</label>
                                            <textarea class="form-control" id="reviewContent" name="reviewContent" rows="3" required></textarea>
                                        </div>
                                        <button type="submit" class="btn btn-primary">리뷰 작성</button>
                                    </form>
                                </div>
                                <div th:each="review : ${reviews}">
                                    <div class="lecture-detail-review">
                                        <p>
                                            <strong th:text="${review.userId}"></strong>
                                            <span>
                                                <i class="fa fa-star" th:if="${review.rating >= 1}"></i>
                                                <i class="fa fa-star-half-alt" th:if="${review.rating >= 0.5 && review.rating < 1}"></i>
                                                <i class="fa fa-star" th:if="${review.rating < 0.5}" style="color: lightgray;"></i>
                                                <i class="fa fa-star" th:if="${review.rating >= 2}"></i>
                                                <i class="fa fa-star-half-alt" th:if="${review.rating >= 1.5 && review.rating < 2}"></i>
                                                <i class="fa fa-star" th:if="${review.rating < 1.5}" style="color: lightgray;"></i>
                                                <i class="fa fa-star" th:if="${review.rating >= 3}"></i>
                                                <i class="fa fa-star-half-alt" th:if="${review.rating >= 2.5 && review.rating < 3}"></i>
                                                <i class="fa fa-star" th:if="${review.rating < 2.5}" style="color: lightgray;"></i>
                                                <i class="fa fa-star" th:if="${review.rating >= 4}"></i>
                                                <i class="fa fa-star-half-alt" th:if="${review.rating >= 3.5 && review.rating < 4}"></i>
                                                <i class="fa fa-star" th:if="${review.rating < 3.5}" style="color: lightgray;"></i>
                                                <i class="fa fa-star" th:if="${review.rating >= 5}"></i>
                                                <i class="fa fa-star-half-alt" th:if="${review.rating >= 4.5 && review.rating < 5}"></i>
                                                <i class="fa fa-star" th:if="${review.rating < 4.5}" style="color: lightgray;"></i>
                                            </span>
                                        </p>
                                        <p th:text="${review.reviewContent}"></p>
                                        <p>
                                            <small th:text="${#dates.format(review.reviewDate, 'yyyy-MM-dd HH:mm')}"></small>
                                        </p>
                                    </div>
                                    <hr>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="questions" role="tabpanel" aria-labelledby="questions-tab">
                            <div class="lecture-detail-content-section">
                                <h3>Q&A</h3>
                                <div th:each="question : ${questions}">
                                    <div class="lecture-detail-question">
                                        <p><strong th:text="${question.userId}"></strong>: <span th:text="${question.content}"></span></p>
                                        <div th:each="answer : ${question.answers}">
                                            <div class="lecture-detail-answer" style="margin-left: 20px;">
                                                <p><strong th:text="${answer.instructorId}"></strong>: <span th:text="${answer.content}"></span></p>
                                            </div>
                                        </div>
                                    </div>
                                    <div th:if="${loggedInUser.role == 'instructor' and lecture.instructorId == loggedInUser.userId}">
                                        <form th:action="@{/lectures/answers}" method="post">
                                            <input type="hidden" name="questionId" th:value="${question.id}" />
                                            <div class="form-group">
                                                <label for="answerContent">답변</label>
                                                <textarea class="form-control" id="answerContent" name="content" rows="3" required></textarea>
                                            </div>
                                            <button type="submit" class="btn btn-primary">답변달기</button>
                                        </form>
                                    </div>
                                </div>
                                <div th:if="${hasApplied}">
                                    <form th:action="@{/lectures/questions}" method="post" onsubmit="localStorage.setItem('activeTab', '#questions');">
                                        <input type="hidden" name="lectureId" th:value="${lecture.lectureId}">
                                        <div class="form-group">
                                            <label for="questionContent">질문</label>
                                            <textarea class="form-control" id="questionContent" name="content" rows="3" required></textarea>
                                        </div>
                                        <button type="submit" class="btn btn-primary">질문달기</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-lg-4 lecture-detail-right-column">
                    <div class="card">
                        <div class="card-body">
                            <th:block th:if="${lecture.instructorId} != ${loggedInUser.userId}">
	                            <h5 class="card-title" th:if="${hasApplied}">학습중</h5>
	                            <h5 class="card-title" th:if="${!hasApplied}">수강 신청</h5>
	                            <a th:if="${hasApplied}" th:href="@{'/videos/player?lectureId=' + ${lecture.lectureId}}"><button class="btn btn-success btn-block mb-3">학습하기</button></a>
	                            <button th:if="${!hasApplied}" data-toggle="modal" data-target="#paymentModal" class="btn btn-primary btn-block mb-3">수강 신청하기</button>
                            </th:block>
<<<<<<< HEAD
                            <th:block th:if="${lecture.instructorId} == ${loggedInUser.userId}">
=======
                            <th:block th:unless="${lecture.instructorId} != ${loggedInUser.userId}">
>>>>>>> branch 'dev' of https://github.com/ddochiisrich/FinalProject_JJOL
                            	<h5 class="card-title">나의 강의입니다.</h5>
                            </th:block>
                            <form th:action="@{/lectures/apply}" method="post" id="lectureAppleyForm">
				                <input type="hidden" name="lectureId" th:value="${lecture.lectureId}">
				            </form>
                            <div class="card-text">
                                <p><strong>지식공유자:</strong> <span th:text="${lecture.instructorName}"></span></p>
                                <p><strong>총 28개 수업:</strong> 5시간 21분</p>
                                <p><strong>수강기한:</strong> 무제한</p>
                                <p><strong>수준:</strong> 입문 - 초급 - 중급 이상</p>
                            </div>
                        </div>
                    </div>
                    <div class="card mt-3">
                        <div class="card-body">
                            <h5 class="card-title">수강 전 궁금한 점이 있나요?</h5>
                            <button class="btn btn-outline-primary btn-block">문의하기</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 강의 결제 모달 -->
            <div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="paymentModalLabel">강의 구매하기</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <h5>강의 정보</h5>
                            <div class="row">
                                <div class="col lecture-detail-test-secondary">
                                    <span>강의명</span><br>
                                    <span>강사</span><br>
                                    <span>가격</span><br>
                                </div>
                                <div class="col">
                                    <span id="lectureTitle">[[ ${lecture.lectureTitle} ]]</span><br>
                                    <span>[[ ${lecture.instructorName} ]]</span><br>
                                    <span id="lecturePrice" th:text="${lecture.lecturePrice}"></span>원 <span>(할인 [[ ${lecture.lectureDiscount} ]]% 적용)</span>
									<br>
                                </div>
                            </div>
                            <h5 class="mt-5">구매자 정보</h5>
                            <input type="hidden" name="userId" th:value="${loggedInUser.userId}" id="userId"/>
                            <input type="hidden" th:value="${lecture.lectureId}" id="lectureId"/>
                            <div class="row">
                                <div class="col lecture-detail-test-secondary">
                                    <span>이름</span><br>
                                    <span>이메일</span><br>
                                    <span>휴대폰 번호</span>
                                </div>
                                <div class="col">
                                    <span>[[ ${session.loggedInUser.name} ]]</span><br>
                                    <span>[[ ${session.loggedInUser.email} ]]</span><br>
                                    <span>[[ ${session.loggedInUser.phone} ]]</span>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col">
                                    <span class="fw-bold">포인트</span>
                                </div>
                                <div class="col text-end">
                                    보유(결제 후) <span id="havePoint">[[ ${session.loggedInUser.point} ]]</span>p
                                </div>
                            </div>
                            <div class="row">
                                <div class="col">
                                    <input type="number" min="0" id="pointInput" value="0"/>
                                    <button class="fw-bold" id="useAllPoint">전액 사용</button>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col">
                                    <span>포인트 적용 후</span>
                                </div>
                                <div class="col">
                                    <span id="priceAfterPoint" th:text="${lecture.lecturePrice}"></span>원
                                </div>
                            </div>
                            <div class="row">
                                <div class="col">
                                    <span>적립예정 포인트(5%)</span>
                                </div>
                                <div class="col">
                                    <span id="earningPoint">0</span>p
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">닫기</button>
                            <button type="button" class="btn btn-primary" id="payBt">카카오페이 결제</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </th:block>
</body>
</html>
